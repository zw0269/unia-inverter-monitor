# Phase 2 实施计划

## Phase 2 概述

**目标：** 在 Phase 1 基础上，完善系统的核心业务功能，包括收益计算、参数配置、设备管理、智能电表集成和图表功能恢复。

**开发周期：** 预计 3-4 周

**团队规模：** 3-4 个并行开发 Agent

**技术基础：**
- 已完成 Phase 1 的页面架构、组件库、Store 模块
- 已有完整的 TypeScript 类型系统
- 已有 Mock 数据生成能力
- 已有蓝牙连接管理框架

---

## 技术选型决策

### 1. 图表库选择

**决策：使用 ECharts + lime-echart**

**理由：**
- ✅ ECharts 已在 package.json 中安装（v5.5.0）
- ✅ 功能强大，支持丰富的图表类型
- ✅ 性能优秀，支持大数据量
- ✅ 文档完善，社区活跃
- ✅ lime-echart 是专为 uni-app 优化的 ECharts 封装
- ⚠️ 需要注意小程序平台的性能优化

**备选方案：** uCharts（更轻量，但功能较弱）

### 2. 数据存储方案

**决策：Pinia Store + uni.storage 持久化**

**结构设计：**
```typescript
// 新增 Store 模块
stores/
  ├── modules/
  │   ├── app.ts          // ✅ 已存在
  │   ├── bluetooth.ts    // ✅ 已存在
  │   ├── device.ts       // ✅ 已存在
  │   ├── revenue.ts      // 🆕 收益计算
  │   ├── settings.ts     // 🆕 参数设置
  │   ├── meter.ts        // 🆕 电表数据
  │   └── chart.ts        // 🆕 图表数据管理
```

### 3. 表单验证方案

**决策：自定义验证函数 + TypeScript 类型约束**

### 4. 时间处理方案

**决策：dayjs（已安装 v1.11.10）**

### 5. 数据持久化策略

**决策：uni.storage + 自动同步机制**

---

## 任务拆分

### Task 1: 收益计算与图表恢复模块 ⭐⭐⭐

**优先级：** 高 (P0)

**目标功能：**
1. 实时收益计算和显示
2. 历史收益统计
3. 收益趋势图表
4. 电价配置管理
5. 发电量趋势图表
6. 功率曲线图表
7. 效率分析图表

**新增文件：** 13 个文件，~3,500 行代码
**修改文件：** 3 个文件

### Task 2: 参数设置与设备配置模块 ⭐⭐

**优先级：** 高 (P0)

**目标功能：**
1. 设备参数配置
2. 系统设置
3. 通信参数配置
4. 用户偏好设置
5. 设置数据持久化

**新增文件：** 13 个文件，~3,500 行代码
**修改文件：** 4 个文件

### Task 3: 智能电表集成与能耗分析模块 ⭐⭐

**优先级：** 中 (P1)

**目标功能：**
1. 电表数据读取和显示
2. 用电统计
3. 峰谷平时段识别
4. 电费计算
5. 自发自用率计算
6. 用电与发电对比分析

**新增文件：** 11 个文件，~3,300 行代码
**修改文件：** 3 个文件

### Task 4: 设备添加流程优化模块 ⭐

**优先级：** 中 (P1)

**目标功能：**
1. 设备扫描优化
2. 设备信息输入表单
3. 连接配置向导
4. 添加成功确认
5. 设备列表管理
6. 设备删除/编辑功能

**新增文件：** 8 个文件，~2,900 行代码
**修改文件：** 5 个文件

---

## 任务依赖关系

```
Task 1 (收益计算与图表) ← 核心基础
    │
    ├─── Task 3 (智能电表) ← 依赖 Task 1 的收益计算
    │
    └─── Task 2 (参数设置) ← 部分依赖（电价配置）

Task 4 (设备添加) ← 完全独立，可并行
```

## 推荐执行顺序

**第一批（并行启动）：**
- 🔵 Agent A: **Task 1** - 收益计算与图表恢复
- 🟠 Agent B: **Task 4** - 设备添加流程

**第二批（等待 Task 1 完成）：**
- 🟢 Agent C: **Task 2** - 参数设置
- 🟡 Agent D: **Task 3** - 智能电表集成

---

## 统计数据

| 项目 | 数量 |
|------|------|
| 总文件数 | 49 个 |
| 总代码量 | ~13,670 行 |
| Store 模块 | 4 个 |
| 类型定义 | 6 个 |
| 工具函数 | 6 个 |
| 业务组件 | 8 个 |
| 通用组件 | 6 个 |
| 页面文件 | 15 个 |

---

## 验收标准

### 功能验收
- ✅ 所有页面正常访问
- ✅ 图表正确渲染
- ✅ 数据计算准确
- ✅ 表单验证完善
- ✅ 数据持久化正常

### 性能验收
- 页面加载 < 1s
- 图表渲染 ≥30fps
- 内存占用 < 200MB

### 代码质量验收
- TypeScript 无类型错误
- ESLint 无错误
- 代码注释覆盖率 ≥ 30%

---

## 风险评估

| 风险 | 等级 | 应对策略 |
|------|------|---------|
| 图表库在小程序性能问题 | 🟡 中 | 数据分页加载 |
| 电表数据源未明确 | 🟡 中 | 先用 Mock 数据 |
| 电价计算复杂度高 | 🟡 中 | 分步实现 |
| Task 依赖导致串行开发 | 🟡 中 | 优先完成 Task 1 |

---

**计划制定时间：** 2026-02-12
**计划版本：** v1.0
**制定人：** Phase 2 管理 Agent
