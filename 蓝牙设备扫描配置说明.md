# 蓝牙设备扫描配置说明

**更新时间**: 2026-02-12
**状态**: ✅ 已优化为接受所有设备

---

## 🎉 问题已解决

### 原因
之前的配置使用了严格的设备过滤器，只接受特定名称的设备：
- `namePrefix: '125kW'`
- `namePrefix: 'Inverter'`
- `namePrefix: 'BLE'`

这导致大部分蓝牙设备被过滤掉，显示"找不到兼容设备"。

### 解决方案
已修改为 **接受所有蓝牙设备** 模式：
```typescript
acceptAllDevices: true  // ✅ 显示所有设备
```

---

## 🚀 现在的行为

### 点击"扫描设备"后
1. 弹出浏览器蓝牙设备选择器
2. **显示所有附近的蓝牙设备**（不再过滤）
3. 可以选择任意设备进行连接
4. 连接后尝试通信

### 设备列表示例
```
📱 设备选择器
├─ 我的手机
├─ 蓝牙耳机
├─ 智能手表
├─ 光伏逆变器  ← 您的设备
├─ 其他BLE设备
└─ ...
```

---

## ⚙️ 配置选项

### 当前配置：开发测试模式（推荐）

**文件**: `F:\unia\src\api\bluetooth\web.ts`
**位置**: 第51-56行

```typescript
// ✅ 当前配置：接受所有设备
const device = await navigator.bluetooth.requestDevice({
  acceptAllDevices: true,
  optionalServices: [this.SERVICE_UUID]
})
```

**优点**:
- ✅ 可以看到所有蓝牙设备
- ✅ 便于测试和开发
- ✅ 无需知道设备确切名称

**缺点**:
- ⚠️ 用户可能看到很多无关设备
- ⚠️ 需要手动识别目标设备

---

### 可选配置：生产模式（过滤器）

如果您知道设备的确切名称或UUID，可以使用过滤器：

```typescript
// 生产模式：使用过滤器
const device = await navigator.bluetooth.requestDevice({
  filters: [
    { namePrefix: '您的设备名称前缀' },
    { name: '确切设备名称' },
    { services: ['设备的服务UUID'] }
  ],
  optionalServices: [this.SERVICE_UUID]
})
```

**示例配置**:

#### 1. 按名称前缀过滤
```typescript
filters: [
  { namePrefix: 'HN-125K' },  // 华能125kW
  { namePrefix: 'Solar' },     // 太阳能设备
  { namePrefix: 'Inverter' }   // 逆变器
]
```

#### 2. 按确切名称过滤
```typescript
filters: [
  { name: 'HN-125K-T-001' }  // 精确匹配
]
```

#### 3. 按服务UUID过滤
```typescript
filters: [
  { services: ['0000fff0-0000-1000-8000-00805f9b34fb'] }
]
```

#### 4. 组合过滤
```typescript
filters: [
  {
    namePrefix: 'HN',
    services: ['0000fff0-0000-1000-8000-00805f9b34fb']
  }
]
```

---

## 🔍 如何找到您的设备信息

### 方法1: 使用acceptAllDevices查看所有设备

1. 当前配置已启用acceptAllDevices
2. 点击"扫描设备"
3. 在设备列表中找到您的设备
4. 记下设备名称

### 方法2: 使用Chrome蓝牙调试工具

1. Chrome地址栏输入：`chrome://bluetooth-internals`
2. 点击"Devices"标签
3. 点击"Start Scan"
4. 查看所有设备的详细信息：
   - 设备名称
   - 设备ID
   - 服务UUID列表
   - 信号强度

### 方法3: 查看设备说明书

查看您的光伏逆变器或数据棒的技术文档：
- 蓝牙设备名称
- 服务UUID
- 特征UUID
- 通信协议

---

## 📝 配置步骤（如需使用过滤器）

### 步骤1: 获取设备信息

使用上述方法获取：
- 设备名称或名称前缀
- 服务UUID（可选）

### 步骤2: 修改配置文件

**文件**: `F:\unia\src\api\bluetooth\web.ts`

找到第43-73行的`startDiscovery`方法：

```typescript
// 禁用 acceptAllDevices 配置
/*
const device = await navigator.bluetooth.requestDevice({
  acceptAllDevices: true,
  optionalServices: [this.SERVICE_UUID]
})
*/

// 启用过滤器配置
const device = await navigator.bluetooth.requestDevice({
  filters: [
    { namePrefix: '您的设备名称前缀' }
  ],
  optionalServices: [this.SERVICE_UUID]
})
```

### 步骤3: 修改UUID（如果需要）

如果您的设备使用不同的UUID，修改第20-21行：

```typescript
private readonly SERVICE_UUID = '您的服务UUID'
private readonly CHARACTERISTIC_UUID = '您的特征UUID'
```

### 步骤4: 重启服务器

```bash
# Ctrl + C 停止服务器
npm run dev:h5
```

### 步骤5: 刷新浏览器并测试

```
Ctrl + Shift + R
```

---

## 🎯 推荐配置方案

### 开发阶段（当前配置）✅
```typescript
acceptAllDevices: true  // 可以看到所有设备，便于测试
```

### 测试阶段
```typescript
filters: [
  { namePrefix: '已知设备前缀' }  // 缩小范围，但仍较宽松
]
```

### 生产阶段
```typescript
filters: [
  {
    namePrefix: '精确前缀',
    services: ['精确UUID']  // 最严格，只显示目标设备
  }
]
```

---

## ⚠️ 常见问题

### Q1: 还是找不到设备？
**A**: 确认：
1. 设备蓝牙已开启
2. 设备未被其他设备连接
3. 设备在蓝牙范围内（<10米）
4. 使用Chrome浏览器
5. 访问地址是localhost

### Q2: 看到很多无关设备？
**A**: 这是正常的，因为使用了`acceptAllDevices: true`。可以：
1. 手动识别目标设备（通过名称）
2. 配置过滤器减少设备数量

### Q3: 连接后无数据？
**A**: 可能原因：
1. UUID配置不正确
2. 设备协议不匹配
3. 数据解析逻辑错误

查看浏览器控制台的错误信息。

### Q4: 如何识别我的设备？
**A**: 查找包含以下关键词的设备名称：
- Inverter（逆变器）
- Solar（太阳能）
- PV（光伏）
- BLE、BT（蓝牙）
- 您的设备品牌名称

---

## 📊 配置对比

| 配置 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| acceptAllDevices | 显示所有设备 | 设备列表长 | 开发测试 |
| namePrefix | 部分过滤 | 需要知道前缀 | 日常使用 |
| name | 精确匹配 | 需要完整名称 | 已知设备 |
| services | UUID过滤 | 需要UUID | 专业用途 |

---

## 🔧 快速切换配置

### 切换到"接受所有设备"
```typescript
const device = await navigator.bluetooth.requestDevice({
  acceptAllDevices: true,
  optionalServices: [this.SERVICE_UUID]
})
```

### 切换到"过滤器模式"
```typescript
const device = await navigator.bluetooth.requestDevice({
  filters: [{ namePrefix: 'Your' }],
  optionalServices: [this.SERVICE_UUID]
})
```

---

## 📞 需要帮助？

### 查看相关文件
- Web蓝牙配置：`F:\unia\src\api\bluetooth\web.ts`
- 使用说明：`F:\unia\Web Bluetooth使用说明.md`
- 测试指南：`F:\unia\Web Bluetooth快速测试指南.md`

### 调试工具
- Chrome蓝牙：`chrome://bluetooth-internals`
- 浏览器控制台：`F12` → Console标签

---

**现在刷新浏览器，再次点击"扫描设备"，应该可以看到所有蓝牙设备了！** 🎉

---

*配置说明由协调者创建*
*最后更新: 2026-02-12*
